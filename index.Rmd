---
title: "Building, Crossdating, and Analyzing a Tree Ring Chronology from New York's Genesee Valley"
author: "Greg Bream"
---

## Introduction
##### The Genesee Valley of western New York is known for its historic oak trees. Building a mean-value chronology of trees cored in this area will allow me to infer the general environmental conditions at a given time. Crossdating will allow me to be more confident in the dates assigned and yield accuracy to the values in the chronology. Droughts, for example can be inferred from years with consistently narrow rings within the chronology.  This can be explored further by crossdating with the Palmer drought severity index. Identifying growth releases of the cored trees will allow me to identify canopy disturbance events using time periods with consistently high values.  

## Materials and methods

Narrative and most code will go here.  Describe what you are doing and show how to do it (with code).

Materials:

* Personally collected tree ring-width data of oak trees in the form of CSV and compact files


### Study Area
##### Tree cores were collected from various species of Oaks from Irondequoit, NY near the shore of Lake Ontario southward through the Genesee Valley to Dalton, NY.  These areas experience relatively different patterns of precipitation annually.  Some cored trees were located in close proximity to bodies of water, while others in inherantly drier environments.  The specific environment each tree grew in likely had an impact on growth trends specific to each, as well as resistance to drought and other disturbance events.  For instance, some of the trees located more to the south lie at the eastern edge of Lake Erie's snowbelt and thus experience a greater amount of winter precipitation.  Other trees, meanwhile at the northern edge of the study area experience frequent snowfall enhancement from Lake Ontario during synoptic events.
```{r message =FALSE, echo = FALSE}
library(dplyr)
library(leaflet)
Tree_Locations <- read.csv("https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/Oak_Coords_Taxa.csv")

Tree_map <- leaflet(data = Tree_Locations) %>% setView(lng = -77.65, lat = 42.84, zoom = 8.5)

tree_icon <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/Tree_icon.png",
  iconWidth = 40, iconHeight = 40,
  iconAnchorX = 0, iconAnchorY = 0)

Tree_map <- Tree_map %>% addTiles() %>%
  addMarkers(~Lon, ~Lat, popup = ~as.character(Site_ID), label = ~as.character(Site_ID), icon = tree_icon)
  
Tree_map

```

### Plotting the Tree-Ring Series

```{r message=FALSE }
library(dplR)
QuercusMaster <- read.rwl("https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/QuercusMaster.csv")
plot(QuercusMaster, plot.type = "spag")
```

### Detrending the Series
##### In dendrochronology, detrending is the fitting of a curve to the ring-width data and removing patterns unique to each tree.  This includes the effects of tree age, disturbance events, and other growth trends due to site-specific drivers of change.  I chose to use a conservative approach to detrending the series in order to remove low-frequency long-term growth trends, but to maintain the higher frequency short-term trends. To do this, I used the function detrend().  The method argument specifies the detrending method, which in this case is fitting a negative exponential curve to the series.  The correlation of each series with the master is calculated using interseries.cor() and the results are in the table below.  Values of .32 or higher indicate a significant correlation and are in green.  As a note, other methods of detrending do exist and are implemented based on the specific research goals.  Choosing not to detrend is also an option, which involves just taking the mean width of all trees in a chronology.
```{r, message=F, warning=F}
QuercusMaster.rwi <- detrend(rwl = QuercusMaster, method = "ModNegExp")

Interseries_Cor <- interseries.cor(QuercusMaster.rwi, prewhiten=TRUE,
                                       method="spearman")
#Changing column names
names(Interseries_Cor)[1]<-"Correlation"
names(Interseries_Cor)[2]<-"P-value"

library(kableExtra)
library(magick)
  kable(Interseries_Cor, digits = c(2, 4)) %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left", font_size = 13, fixed_thead = T) %>%
    row_spec(which(Interseries_Cor$Correlation >= .32), bold = T, color = "green", background = NULL) %>%
    scroll_box(width = "700px", height = "300px")
    
```

### Mean Value Chronology
##### Building a Mean Value Chronology out of the .rwi object created above using chron().  By default, chron() uses Tukey's biweight robust mean, which is unaffected by outliers and thus is a more accurate representation of the data.  The plot below plots the newly created mean chronology.  The second and third arguments of plot(), add.spline and nyrs add a smoothing spline with a wavelength (period) of 20 years.  To add clarification, the rwi, or ring-width index involves dividing each of the ring-width series by the growth trend and represents standardization of the chronology (Bunn, 2008).
```{r}
QuercusMasterFINAL <- subset(QuercusMaster.rwi,select= -c(X182.12QR, X224., X92., X23.8QM, X183.8QR, X135.4QR, X117.8QA, X233.12QA, X276.4QR, X202.16QA, X118., X62.8QV, X16.16QA, X230.16QV, X129.16QR, X205.8QR, X240.12QR, X79.8QM, X206.12QA, X223.4QA, X237.8QR))
  

QuercusMaster.crn <- chron(QuercusMasterFINAL, prefix = "CAM")

plot(QuercusMaster.crn, add.spline=TRUE, nyrs=20)
```


### Crossdating 
##### Crossdating is of absolute importance in dendrochronology.  It involves identifying similar patterns in radial grown between multiple trees and applying those patterns to trees of unknown dates in order to ascertain the correct tree age.  In short, it assures that you are assigning the correct calendar year to the growth rings of each tree.  In the case of my cores, I am already able to accurately assign dates, since the trees were living at the time of coring and I have the dates of measurement.  The field of dendrochronology is unique in the sciences in that series that don't crossdate well with others can be excluded in order to more accurately assess growth response to environmental or climatic conditions (Carrer, 2011).  In my study, I removed 21 series that fell below the significance threshold of 0.32 before checking for crossdating errors with corr.rwl.seg().  The argument seg.length specifies the length of the segments to crossdate.  I chose the segment length to be 50 years, which is likely the longest segment that I should use, since the average series length is approximately 100 years.  By default, the overlap for the segments is half of the segment length, 25 years.  The pcrit argument specifies the critical value for the correlation.  The blue segments on the first plot below represent a significant correlation for that segment, while the red represent low correlations and thus, crossdating issues.  

```{r }
Cross_SEGS <- corr.rwl.seg(QuercusMasterFINAL, seg.length = 50, pcrit = 0.10)



```


### Growth Releases
##### Growth releases are periods in a trees growth where ring-width is at least 25% greater than mean of both the preceding and subsequent 10 year period, and lasting several years (Nowacki & Abrams, 1997).  A change of 50% signifies a major release.  A growth release means that some type of disturbance event occurred near the tree.  This includes death of nearby trees due to natural or human-driven causes.  The function below, growthAveragingALL(), calculates growth releases in each series and produces graphs for each of the series in the chronology.  One thing that stands out to me is that multiple trees experienced growth releases at 1991.  Through taking measurements, 1991 was deemed what is called an indicator year.  That is, a year that is consistently narrow across the majority of the tree cores.  Through crossdating with the Palmer drought severity index (PDSI), this lack of growth was likely due to drought.  What I find interesting about this is that three of the series, x133-12QA, x165-QR, and x187-12QR experienced significantly increased growth during this time.  It is likely that these trees were smaller and in the understory, and death of larger tree or trees in the canopy lead to in increase in available light and consequently, an increase in growth rate. 
```{r message=FALSE}
library(TRADER)
library(jpeg)
Quercus_nopartials <- read.rwl("https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/Quercus_Nopartials.csv")

#Radial Growth Averaging for Quercus (all)
growthAveragingALL(Quercus_nopartials, releases = NULL, m1 = 10, m2 = 10, buffer = 10, prefix = "ga", drawing = TRUE, criteria = 0.25, criteria2 = 0.5, gfun = mean, length = 5, storedev = jpeg)
#Prefix "ga" just means that it's the growth average(ga).  If this was for the absoluteIncreaseALL() function, I would put the prefix as "ai" for absolute increase.
# Define variable containing url
GA_165 <- "https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/ga_165-QR.jpeg"
GA_133 <- "https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/ga_X133.12QA.jpeg"
GA_187 <- "https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/ga_X187.12QR.jpeg"

```
<center><img src="`r GA_165`"></center>
<center><img src="`r GA_133`"></center>
<center><img src="`r GA_187`"></center>

### PDSI Correlation
##### As mentioned above, a comparison of the mean value chronology and the Palmer Drought Severity Index (PDSI) shows a probable correlation.  In many cases, annual variance in ring width can be explained by moisture conditions.
```{r message = FALSE}
PDSI <- read.csv("https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/PDSI_Vals.csv")
QChron <- read.csv("https://raw.githubusercontent.com/geo511-2019/2019-geo511-project-gbream/master/data/QChron2.csv")

library(ggplot2)
Chron_vs_PDSI <-
  ggplot() + 
  geom_line(data = QChron, aes(x = Year, y = Value), color = "blue") +
  geom_line(data = PDSI, aes(x = Year, y = Value/8), color = "red") +
  geom_vline(xintercept=1965, linetype = "dotted")+
  geom_vline(xintercept=1900, linetype = "dotted")+
  geom_vline(xintercept=1934, linetype = "dotted")+
  geom_vline(xintercept=1991, linetype = "dotted")+
  scale_y_continuous(sec.axis = sec_axis(~., name = "PDSI_met")) +
  ggtitle("Mean RWI Chronology & PDSI Values")

Chron_vs_PDSI

```

## Conclusions

This is my second draft.

## References
Bunn AG. (2008). A dendrochronology program library in R (dplR). Dendrochronologia, 26, 115â€“124.

Carrer, M. (2011). Individualistic and time-Varying tree-ring growth to climate sensitivity. PloS one, 6(7), e22813. doi: 10.1371/journal.pone.0022813 

Nowacki GJ & Abrams, MD. (2008). Radial-growth averaging criteria for reconstructing disturbance histories from presettlement-origin oaks. Ecological Monographs, 67.

Sullivan PF, Pattison, RR, Brownlee, AH, Cahoon SMP, & Hollingsworth, TN. (2016). Effect of tree-ring detrending method on apparent growth trends of black and white spruce in interior Alaska. Environmental Research Letters, 11 (11).
